# Bookstore 总体设计文档

author : serene_analysis

### 程序功能概述

实现了一个书店管理系统。该书店管理系统面向三类人员：顾客、销售人员和店长。

顾客可以查询和购买图书。销售人员可以执行所有顾客执行的操作，同时也可以进行进货、图书信息录入、图书信息修改、用户创建。店长可以执行所有销售人员和顾客可以执行的功能，同时也可以查询某段时间的采购信息、销售情况、盈利信息，以及查看各员工的工作情况报告和系统的整体工作日志。

### 主体逻辑说明

由交互器（来自 interactor.h）负责从外部读取输入，其调用语法检查器（来自 checker.h）检查本次输入的指令是否合法。如不合法，则结束本次输入。如是 $\texttt{quit}$ 或 $\texttt{exit}$，则结束程序。如合法且不是 $\texttt{quit}$ 或 $\texttt{exit}$，根据指令类型交由账户系统（来自 account.h）、图书系统（来自 book.h）或日志系统（来自 log.h）处理。数据存储由块状链表（来自 blocklist.h）负责。

### 代码文件结构



### 功能设计与数据库设计

交互器：负责与用户进行信息交互，此处即读入指令。

语法检查器：检查从交互器处得到的指令是否合法，如果不合法直接返回，如果合法根据指令类型将指令传递给账户系统、图书系统或日志系统。

日志系统：负责管理日志。具体地说，支持：
- 以 BlockList 形式维护一个财务日志 finance.data, 信息形式为 $\texttt{pair<Id,pair<IncomeSum,ExpenseSum>>}$ （即收入与支出的前缀和）；以 BlockList 形式维护一个总体日志 log.data，信息形式为 $\texttt{pair<Id,Info>}$。

账户系统：负责管理账户。具体地说，支持：

- 以 BlockList 形式维护一个登录栈 stack.data 和一个账户文件 account.data，account.data 信息形式为 $\texttt{pair<UserId,tuple<Password,Privilege,Username,Selected>>}$，其中 Selected 使用 $\texttt{pair<ISBN,tuple<...>>}$，stack.data 信息形式为 account.data 信息形式在开头再加上一个 Id。以 BlockList 形式维护 UserId 到栈中位置的映射 map.data，信息形式为 $\texttt{pair<UserId,int>}$。
- 登录账户。找到 account.data 中 UserId 匹配的账户进行操作，修改 stack.data。
- 注销账户。找到 account.data 中 UserId 匹配的账户进行操作，修改 stack.data。
- 注册账户。检查 account.data，无冲突则修改 account.data 。
- 修改密码。找到 account.data 中 UserId 匹配的账户进行操作，修改 account.data。
- 创建账户。检查 account.data，无冲突则修改 account.data 。
- 删除账户。检查 account.data 和 stack.data，账户存在且未登录则修改 account.data。
- 以上操作同步修改 log.data。

图书系统：负责管理图书。具体地说，支持：

- 以 BlockList 形式维护图书文件 isbn.data, name.data, author.data, keyword.data。信息形式为 $\texttt{pair<SortKeyword,tuple<ISBN,Name,Author,Keyword,Price,Quantity>>}$。
- 检索图书。如果附加参数为空或 Keyword 中出现多个关键词则 fail，否则根据所给附加参数到对应的文件中查找。
- 购买图书。找到 isbn.data 中对应的图书，如果购买合法则修改四个文件中对应的内容。
- 选择图书。找到 isbn.data 中对应的图书（如果没有则创建并修改四个文件的内容），然后修改 stack.data。
- 修改图书信息。如果未选中图书或附加参数重复或附加参数内容为空或将 ISBN 改为原本出现过的 ISBN 或 Keyword 包含重复信息段则 fail，否则修改四个文件和 stack.data。可以 0 元卖。
- 图书进货。如果未选中图书或购入数量为非正整数或交易总额为非正数则 fail，否则修改四个文件和 stack.data。不能 0 元买。
- 以上操作同步修改 finance.data 和 log.data。

### 类、结构体设计

MemoryRiver：BlockList 的具体实现，负责和文件进行交互。

BlockList：外界直接调用的块状链表，支持按 pair 的第一关键字为顺序插入元素、删除元素、修改元素、返回特定下标的元素、返回第一关键字正确的元素、返回完全匹配的元素，由 MemoryRiver 负责具体实现。

Interactor：交互器，负责读入指令。

GrammarChecker：语法检查器，负责检查从 Interactor 处得到的输入的语法是否正确，并处理得到的正确请求，将其下发给三个子系统。

AccountSystem：账户系统，功能如上。

BookSystem：图书系统，功能如上。

LogSystem：日志系统，功能如上。